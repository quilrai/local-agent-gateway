<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="base.css" />
    <link rel="stylesheet" href="components.css" />
    <link rel="stylesheet" href="pages.css" />
    <link rel="stylesheet" href="dark-mode.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Gateway</title>
    <script src="lib/chart.min.js"></script>
    <script src="lib/lucide.min.js"></script>
    <script type="module" src="/main.js" defer></script>
  </head>

  <body>
    <div class="app-container">
      <!-- Sidebar -->
      <nav class="sidebar">
        <div class="sidebar-header">
          <h2>Agent Gateway <span class="header-branding"><span class="made-by">by</span> <a href="https://quilr.ai" target="_blank">QuilrAI</a></span></h2>
        </div>
        <ul class="nav-tabs">
          <li class="nav-item active" data-tab="home">
            <span class="nav-icon"><i data-lucide="layout-dashboard"></i></span>
            <span class="nav-text">Dashboard</span>
            <span class="nav-info" data-tooltip="Overview of stats for requests that went through"><i data-lucide="info"></i></span>
          </li>
          <li class="nav-item" data-tab="logs">
            <span class="nav-icon"><i data-lucide="file-text"></i></span>
            <span class="nav-text">Message Logs</span>
            <span class="nav-info" data-tooltip="Full logs of requests and responses"><i data-lucide="info"></i></span>
          </li>
          <li class="nav-item" data-tab="settings">
            <span class="nav-icon"><i data-lucide="settings"></i></span>
            <span class="nav-text">Settings</span>
            <span class="nav-info" data-tooltip="Categories to be blocked, rate limits and other settings"><i data-lucide="info"></i></span>
          </li>
          <li class="nav-item" data-tab="backends">
            <span class="nav-icon"><i data-lucide="server"></i></span>
            <span class="nav-text">LLM Gateway</span>
            <span class="nav-info" data-tooltip="Pass through gateway for your LLMs"><i data-lucide="info"></i></span>
          </li>
          <li class="nav-item" data-tab="howto">
            <span class="nav-icon"><i data-lucide="plug"></i></span>
            <span class="nav-text">Use with your agent</span>
            <span class="nav-info" data-tooltip="Configure Claude Code, Codex, Cursor to use the gateway"><i data-lucide="info"></i></span>
          </li>
        </ul>
        <div class="sidebar-links">
          <a class="sidebar-link" id="starGithub" title="Star on GitHub">
            <i data-lucide="star"></i>
            <span>Star on GitHub</span>
          </a>
          <a class="sidebar-link" id="reportIssue" title="Report Issue">
            <i data-lucide="message-circle"></i>
            <span>Report Issue</span>
          </a>
        </div>
        <div class="sidebar-footer">
          <div class="proxy-status">
            <span class="status-dot starting" id="proxy-status-dot"></span>
            <span id="proxy-status-text">Starting gateway...</span>
          </div>
          <div class="sidebar-branding">
            <span class="made-by">made by</span> <a href="https://quilr.ai" target="_blank">Quilr.ai</a>
          </div>
        </div>
      </nav>

      <!-- Main Content -->
      <main class="content">
        <!-- Dashboard Tab -->
        <div id="home-tab" class="tab-content active">
          <div class="page-header">
            <div class="header-filters">
              <select id="backend-select" class="filter-select">
                <option value="all">All Backends</option>
              </select>
              <select id="time-select" class="filter-select">
                <option value="1h">1 Hour</option>
                <option value="6h">6 Hours</option>
                <option value="1d">1 Day</option>
                <option value="7d">7 Days</option>
              </select>
            </div>
            <button id="refresh-btn" class="icon-btn" title="Refresh">
              <i data-lucide="refresh-cw"></i>
            </button>
          </div>

          <div id="dashboard-content">
            <p class="loading">Loading...</p>
          </div>
        </div>

        <!-- Message Logs Tab -->
        <div id="logs-tab" class="tab-content">
          <div class="page-header">
            <div class="header-filters">
              <select id="logs-backend-select" class="filter-select">
                <option value="all">All Backends</option>
              </select>
              <select id="logs-model-select" class="filter-select">
                <option value="all">All Models</option>
              </select>
              <select id="logs-dlp-select" class="filter-select">
                <option value="all">All Detection Status</option>
                <option value="passed">Passed</option>
                <option value="redacted">Redacted</option>
                <option value="blocked">Blocked</option>
                <option value="ratelimited">Ratelimited</option>
                <option value="notify-ratelimit">Notify-Ratelimit</option>
              </select>
              <select id="logs-time-select" class="filter-select">
                <option value="1h">1 Hour</option>
                <option value="6h">6 Hours</option>
                <option value="1d">1 Day</option>
                <option value="7d">7 Days</option>
              </select>
            </div>
            <div class="header-actions">
              <button id="logs-export-btn" class="icon-btn" title="Export to JSONL">
                <i data-lucide="download"></i>
              </button>
              <button id="logs-refresh-btn" class="icon-btn" title="Refresh">
                <i data-lucide="refresh-cw"></i>
              </button>
            </div>
          </div>
          <div class="logs-toolbar">
            <div class="search-box">
              <input type="text" id="logs-search-input" class="search-input" placeholder="Search messages...">
              <button id="logs-search-btn" class="search-btn" title="Search">
                <i data-lucide="search"></i>
              </button>
            </div>
            <div id="logs-pagination" class="pagination"></div>
          </div>
          <div id="logs-content">
            <p class="loading">Loading...</p>
          </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings-tab" class="tab-content">
          <h1>Settings</h1>

          <div class="settings-section">
            <div class="card">
              <div class="card-header">Passthrough Server</div>
              <div class="card-body">
                <div class="setting-row">
                  <div class="setting-info">
                    <label for="port-input" class="setting-label">Port Number</label>
                    <p class="setting-description">Default: 8008. Use with ANTHROPIC_BASE_URL or OPENAI_BASE_URL.</p>
                  </div>
                  <div class="setting-control">
                    <input type="number" id="port-input" class="port-input" min="1024" max="65535" value="8008" />
                    <button id="save-port-btn" class="btn btn-primary">Save</button>
                  </div>
                </div>
                <div id="settings-status" class="settings-status"></div>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <div class="card">
              <div class="card-header">Sensitive Data Settings</div>
              <div class="card-body">
                <div class="setting-row" style="margin-bottom: 20px;">
                  <div class="setting-info">
                    <label class="setting-label">Detection Action</label>
                    <p class="setting-description" id="dlp-action-description">Sensitive data is redacted before sending to LLM and restored in the response seamlessly. No manual action needed.</p>
                    <p class="setting-note">Cursor supports blocking only.</p>
                  </div>
                  <div class="setting-control">
                    <div class="toggle-switch-container">
                      <span class="toggle-label" id="dlp-action-label-redact">Redact</span>
                      <label class="toggle-switch">
                        <input type="checkbox" id="dlp-action-toggle" />
                        <span class="toggle-slider"></span>
                      </label>
                      <span class="toggle-label" id="dlp-action-label-block">Block</span>
                    </div>
                  </div>
                </div>
                <div id="dlp-action-status" class="settings-status"></div>

                <div class="dlp-section">
                  <div class="dlp-section-header">
                    <h4 class="dlp-section-title">Detection Patterns</h4>
                    <button id="add-pattern-btn" class="btn btn-secondary btn-sm">
                      <i data-lucide="plus"></i>
                      Add Pattern
                    </button>
                  </div>
                  <div class="dlp-pattern-list" id="dlp-patterns">
                    <p class="empty-text">Loading patterns...</p>
                  </div>
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- LLM Gateway Tab -->
        <div id="backends-tab" class="tab-content">
          <h1>LLM Gateway</h1>
          <p class="page-subtitle">Configure data protection, rate limits, and token limits for your LLM backends. Restart the proxy to apply changes.</p>

          <div class="settings-section">
            <div class="card">
              <div class="card-header">
                <span>Pre-defined Backends</span>
              </div>
              <div class="card-body">
                <div id="predefined-backends-list" class="backends-list">
                  <p class="empty-text">Loading backends...</p>
                </div>
              </div>
            </div>
          </div>

          <div class="settings-section">
            <div class="card">
              <div class="card-header">
                <span>Custom Backends</span>
                <button id="add-backend-btn" class="btn btn-primary btn-sm">
                  <i data-lucide="plus"></i>
                  Add Backend
                </button>
              </div>
              <div class="card-body">
                <div id="backends-list" class="backends-list">
                  <p class="empty-text">Loading backends...</p>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Add/Edit Backend Modal -->
        <div id="backend-modal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="backend-modal-title">Add Backend</h3>
              <button class="modal-close" id="close-backend-modal">&times;</button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="backend-id" value="" />

              <div class="form-group">
                <label for="backend-name">Name</label>
                <input type="text" id="backend-name" class="form-input" placeholder="e.g., openai, groq, together" />
                <p class="form-hint">Alphanumeric, hyphens, underscores only. Used in URL: localhost:8008/<strong>name</strong>/...</p>
              </div>

              <div class="form-group">
                <label for="backend-url">Base URL</label>
                <input type="text" id="backend-url" class="form-input" placeholder="e.g., https://api.openai.com" />
                <p class="form-hint">The API base URL. Requests to localhost:8008/name/* will be proxied to this URL.</p>
              </div>

              <div class="form-divider"></div>
              <h4 class="form-section-title">Settings</h4>

              <div class="form-group">
                <div class="setting-toggle-row">
                  <div class="setting-toggle-info">
                    <label>Data Protection</label>
                    <p class="form-hint">Apply detection patterns to detect and handle sensitive data</p>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="backend-dlp-enabled" checked />
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label>Rate Limit</label>
                <div class="rate-limit-row">
                  <input type="number" id="backend-rate-requests" class="form-input rate-input" min="0" value="0" />
                  <span class="rate-label">requests per</span>
                  <input type="number" id="backend-rate-minutes" class="form-input rate-input" min="1" value="1" />
                  <span class="rate-label">minute(s)</span>
                </div>
                <p class="form-hint">Set to 0 requests to disable rate limiting</p>
              </div>

              <div class="form-group">
                <label>Max Tokens per Request</label>
                <div class="rate-limit-row">
                  <input type="number" id="backend-max-tokens" class="form-input rate-input" min="0" value="0" />
                  <span class="rate-label">tokens</span>
                  <select id="backend-max-tokens-action" class="form-input" style="width: auto; margin-left: 10px;">
                    <option value="block">Block</option>
                    <option value="notify">Notify</option>
                  </select>
                  <span class="rate-label">if exceeded</span>
                </div>
                <p class="form-hint">Set to 0 to disable token limit. Block will reject the request, Notify will log only.</p>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" id="cancel-backend-btn">Cancel</button>
              <button class="btn btn-primary" id="save-backend-btn">Save and Restart Gateway</button>
            </div>
          </div>
        </div>

        <!-- Edit Predefined Backend Modal -->
        <div id="predefined-backend-modal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3 id="predefined-backend-modal-title">Edit Backend Settings</h3>
              <button class="modal-close" id="close-predefined-backend-modal">&times;</button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="predefined-backend-name" value="" />

              <div class="form-group">
                <label>Backend Name</label>
                <input type="text" id="predefined-backend-name-display" class="form-input" disabled />
              </div>

              <div class="form-group">
                <label>Base URL</label>
                <input type="text" id="predefined-backend-url-display" class="form-input" disabled />
              </div>

              <div class="form-divider"></div>
              <h4 class="form-section-title">Settings</h4>

              <div class="form-group">
                <div class="setting-toggle-row">
                  <div class="setting-toggle-info">
                    <label>Data Protection</label>
                    <p class="form-hint">Apply detection patterns to detect and handle sensitive data</p>
                  </div>
                  <label class="toggle-switch">
                    <input type="checkbox" id="predefined-backend-dlp-enabled" checked />
                    <span class="toggle-slider"></span>
                  </label>
                </div>
              </div>

              <div class="form-group">
                <label>Rate Limit</label>
                <div class="rate-limit-row">
                  <input type="number" id="predefined-backend-rate-requests" class="form-input rate-input" min="0" value="0" />
                  <span class="rate-label">requests per</span>
                  <input type="number" id="predefined-backend-rate-minutes" class="form-input rate-input" min="1" value="1" />
                  <span class="rate-label">minute(s)</span>
                </div>
                <p class="form-hint">Set to 0 requests to disable rate limiting</p>
              </div>

              <div class="form-group">
                <label>Max Tokens per Request</label>
                <div class="rate-limit-row">
                  <input type="number" id="predefined-backend-max-tokens" class="form-input rate-input" min="0" value="0" />
                  <span class="rate-label">tokens</span>
                  <select id="predefined-backend-max-tokens-action" class="form-input" style="width: auto; margin-left: 10px;">
                    <option value="block">Block</option>
                    <option value="notify">Notify</option>
                  </select>
                  <span class="rate-label">if exceeded</span>
                </div>
                <p class="form-hint">Set to 0 to disable token limit.</p>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" id="reset-predefined-backend-btn">Reset and Restart Gateway</button>
              <button class="btn btn-secondary" id="cancel-predefined-backend-btn">Cancel</button>
              <button class="btn btn-primary" id="save-predefined-backend-btn">Save and Restart Gateway</button>
            </div>
          </div>
        </div>

        <!-- Use with your agent Tab -->
        <div id="howto-tab" class="tab-content">
          <h1>Use with your agent</h1>
          <p class="howto-subtitle">Select a tool to see setup instructions for using it with this proxy.</p>

          <div class="howto-tools">
            <button class="howto-tool-btn" data-tool="claude-code">Claude Code CLI</button>
            <button class="howto-tool-btn" data-tool="cursor">Cursor</button>
            <button class="howto-tool-btn" data-tool="codex">Codex CLI</button>
          </div>

          <div id="howto-instructions" class="howto-instructions">
            <p class="empty-text">Select a tool above to see instructions.</p>
          </div>
        </div>

        <!-- Redact Warning Modal -->
        <div id="redact-warning-modal" class="modal">
          <div class="modal-content">
            <div class="modal-header">
              <h3>Enable Redact Mode?</h3>
              <button class="modal-close" id="close-redact-modal">&times;</button>
            </div>
            <div class="modal-body">
              <div class="warning-content">
                <div class="warning-item">
                  <div class="warning-icon">✓</div>
                  <div class="warning-text">
                    <strong>Seamless redaction</strong>
                    <p>Sensitive info is redacted before sending to LLM and restored in responses, allowing coding agents to function normally.</p>
                  </div>
                </div>
                <div class="warning-item warning-caution">
                  <div class="warning-icon">⚠</div>
                  <div class="warning-text">
                    <strong>Potential file edit issues</strong>
                    <p>May occasionally cause failures when editing files due to context mismatch.</p>
                  </div>
                </div>
                <div class="warning-item warning-info">
                  <div class="warning-icon">ℹ</div>
                  <div class="warning-text">
                    <strong>Cursor compatibility</strong>
                    <p>Cursor only supports Block mode.</p>
                  </div>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" id="cancel-redact-btn">Cancel</button>
              <button class="btn btn-primary" id="confirm-redact-btn">Enable Redact</button>
            </div>
          </div>
        </div>

        <!-- Add/Edit Pattern Modal -->
        <div id="pattern-modal" class="modal">
          <div class="modal-content modal-content-lg">
            <div class="modal-header">
              <h3 id="pattern-modal-title">Add Pattern</h3>
              <button class="modal-close" id="close-pattern-modal">&times;</button>
            </div>
            <div class="modal-body">
              <input type="hidden" id="pattern-id" value="" />

              <div class="form-group">
                <label for="pattern-name">Name</label>
                <input type="text" id="pattern-name" class="form-input" placeholder="e.g., AWS Secrets" />
              </div>

              <div class="form-row">
                <div class="form-group form-group-half">
                  <label>Pattern Type</label>
                  <div class="radio-group">
                    <label class="radio-item">
                      <input type="radio" name="pattern-type" value="keyword" checked />
                      <span>Keywords</span>
                    </label>
                    <label class="radio-item">
                      <input type="radio" name="pattern-type" value="regex" />
                      <span>Regex</span>
                    </label>
                  </div>
                  <p class="form-hint" id="pattern-type-hint">Keywords: case-insensitive literal match. Regex: raw regex patterns (case-sensitive).</p>
                </div>
                <div class="form-group form-group-half">
                  <label>Validation</label>
                  <div class="form-inline">
                    <div class="form-inline-item">
                      <label for="min-unique-chars" class="form-label-sm">Min Unique Chars</label>
                      <input type="number" id="min-unique-chars" class="form-input form-input-sm" min="0" value="0" title="Reject matches with fewer distinct characters (e.g., 'aaa' has 1 unique char)" />
                    </div>
                    <div class="form-inline-item">
                      <label for="min-occurrences" class="form-label-sm">Min Occurrences</label>
                      <input type="number" id="min-occurrences" class="form-input form-input-sm" min="1" value="1" title="Require at least this many matches before flagging" />
                    </div>
                  </div>
                  <p class="form-hint">Filters to reduce false positives.</p>
                </div>
              </div>

              <div class="form-group">
                <label for="pattern-values">Patterns <span class="form-hint">(one per line)</span></label>
                <textarea id="pattern-values" class="form-textarea" rows="4" placeholder="Enter keywords or regex patterns, one per line"></textarea>
              </div>

              <details class="form-details">
                <summary>Negative Patterns (Exclusions)</summary>
                <div class="form-details-content">
                  <p class="form-hint" style="margin-bottom: 12px;">Context-aware exclusion: each match is checked with 30 characters before and after. If a negative pattern appears within that context window, the specific match is excluded.</p>
                  <p class="form-hint" style="margin-bottom: 12px;"><strong>Example:</strong> Pattern <code>sk-[a-z0-9]+</code> with negative <code>test</code> will catch <code>sk-prod456</code> but exclude <code>sk-test123</code> when "test" appears nearby.</p>
                  <div class="form-group">
                    <label>Negative Pattern Type</label>
                    <div class="radio-group">
                      <label class="radio-item">
                        <input type="radio" name="negative-pattern-type" value="" checked />
                        <span>None</span>
                      </label>
                      <label class="radio-item">
                        <input type="radio" name="negative-pattern-type" value="keyword" />
                        <span>Keywords</span>
                      </label>
                      <label class="radio-item">
                        <input type="radio" name="negative-pattern-type" value="regex" />
                        <span>Regex</span>
                      </label>
                    </div>
                  </div>
                  <div class="form-group">
                    <label for="negative-pattern-values">Negative Patterns <span class="form-hint">(one per line)</span></label>
                    <textarea id="negative-pattern-values" class="form-textarea" rows="3" placeholder="e.g., test, example, dummy"></textarea>
                  </div>
                </div>
              </details>

              <details class="form-details">
                <summary>Test Pattern</summary>
                <div class="form-details-content">
                  <div class="form-group">
                    <label for="test-text">Sample Text</label>
                    <textarea id="test-text" class="form-textarea" rows="3" placeholder="Enter text to test your pattern against"></textarea>
                  </div>
                  <button type="button" class="btn btn-secondary btn-sm" id="test-pattern-btn">Test</button>
                  <div id="test-results" class="test-results" style="display: none; margin-top: 12px;"></div>
                </div>
              </details>
            </div>
            <div class="modal-footer">
              <button class="btn btn-secondary" id="cancel-pattern-btn">Cancel</button>
              <button class="btn btn-primary" id="save-pattern-btn">Save</button>
            </div>
          </div>
        </div>
      </main>
    </div>
  </body>
</html>
